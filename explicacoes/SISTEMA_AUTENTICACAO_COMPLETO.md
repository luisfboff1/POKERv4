# üîê Sistema de Autentica√ß√£o - Poker SaaS

## üìã Vis√£o Geral

O sistema implementa **autentica√ß√£o JWT (JSON Web Token)** com arquitetura **multi-tenant** para isolamento de dados por empresa. Inclui controle de roles, auditoria completa e middleware de seguran√ßa.

## üèóÔ∏è Arquitetura do Sistema

### **Frontend (React)**
- **Context API** para gerenciamento de estado de autentica√ß√£o
- **LocalStorage** para persist√™ncia de token e dados do usu√°rio
- **Intercepta√ß√£o autom√°tica** de requisi√ß√µes com token
- **Redirecionamento autom√°tico** em caso de token expirado

### **Backend (PHP)**
- **JWT com assinatura HMAC-SHA256**
- **Middleware de autentica√ß√£o** obrigat√≥rio
- **Sistema de sess√µes** no banco de dados
- **Controle de tentativas** de login com bloqueio
- **Logs de auditoria** completos

## üîÑ Fluxo de Autentica√ß√£o

### **1. Login do Usu√°rio**

```mermaid
sequenceDiagram
    participant U as Usu√°rio
    participant F as Frontend
    participant B as Backend
    participant DB as Banco

    U->>F: Insere email/senha
    F->>B: POST /api/auth.php?action=login
    B->>DB: Valida credenciais
    DB-->>B: Dados do usu√°rio
    B->>B: Gera JWT token
    B->>DB: Salva sess√£o
    B-->>F: Token + dados usu√°rio
    F->>F: Salva no localStorage
    F->>U: Redireciona para dashboard
```

### **2. Verifica√ß√£o de Token**

```mermaid
sequenceDiagram
    participant F as Frontend
    participant B as Backend
    participant DB as Banco

    F->>B: Requisi√ß√£o com Authorization header
    B->>B: Valida assinatura JWT
    B->>DB: Verifica se token n√£o foi invalidado
    DB-->>B: Status do token
    B->>DB: Busca dados atualizados do usu√°rio
    DB-->>B: Dados do usu√°rio
    B-->>F: Resposta autorizada
```

## üìÅ Estrutura de Arquivos

```
api/
‚îú‚îÄ‚îÄ auth.php                 # Endpoints de autentica√ß√£o
‚îú‚îÄ‚îÄ jwt_helper.php           # Gera√ß√£o e valida√ß√£o de JWT
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îî‚îÄ‚îÄ auth_middleware.php  # Middleware de autentica√ß√£o
‚îú‚îÄ‚îÄ config.php               # Configura√ß√µes e CORS
‚îî‚îÄ‚îÄ session.php              # APIs protegidas

src/
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.jsx      # Context de autentica√ß√£o
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ api.js               # Cliente API com intercepta√ß√£o
‚îî‚îÄ‚îÄ pages/
    ‚îî‚îÄ‚îÄ Login/
        ‚îî‚îÄ‚îÄ index.jsx        # P√°gina de login
```

## üîß Implementa√ß√£o T√©cnica

### **Backend - Gera√ß√£o de JWT**

```php
// jwt_helper.php
public static function generateToken($user_data) {
    $header = json_encode(['typ' => 'JWT', 'alg' => 'HS256']);
    
    $payload = json_encode([
        'user_id' => $user_data['id'],
        'tenant_id' => $user_data['tenant_id'],
        'email' => $user_data['email'],
        'name' => $user_data['name'],
        'role' => $user_data['role'],
        'tenant_name' => $user_data['tenant_name'],
        'tenant_plan' => $user_data['tenant_plan'],
        'iat' => time(),
        'exp' => time() + (24 * 60 * 60), // 24 horas
        'iss' => 'poker_saas_system'
    ]);
    
    $base64Header = self::base64UrlEncode($header);
    $base64Payload = self::base64UrlEncode($payload);
    
    $signature = hash_hmac('sha256', 
        $base64Header . "." . $base64Payload, 
        self::getSecretKey(), true);
    $base64Signature = self::base64UrlEncode($signature);
    
    return $base64Header . "." . $base64Payload . "." . $base64Signature;
}
```

### **Frontend - Context de Autentica√ß√£o**

```javascript
// AuthContext.jsx
export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  const login = async (email, password) => {
    try {
      const response = await api.login(email, password);
      setUser(response.data.user);
      return response.data;
    } catch (error) {
      setError(error.message);
      throw error;
    }
  };

  const checkAuth = async () => {
    if (!api.getToken()) {
      setUser(null);
      return;
    }

    try {
      const response = await api.verifyToken();
      setUser(response.data.user);
    } catch (error) {
      setUser(null);
      api.clearAuth();
    }
  };
};
```

### **Middleware de Autentica√ß√£o**

```php
// auth_middleware.php
public static function requireAuth($pdo) {
    $token = JWTHelper::getTokenFromHeaders();
    
    if (!$token) {
        http_response_code(401);
        echo json_encode(['error' => 'Token de autentica√ß√£o necess√°rio']);
        exit;
    }
    
    $payload = JWTHelper::validateToken($token);
    if (!$payload) {
        http_response_code(401);
        echo json_encode(['error' => 'Token inv√°lido ou expirado']);
        exit;
    }
    
    if (!JWTHelper::isTokenValid($pdo, $token)) {
        http_response_code(401);
        echo json_encode(['error' => 'Token foi invalidado']);
        exit;
    }
    
    // Buscar dados atuais do usu√°rio
    $user = self::getCurrentUserData($pdo, $payload['user_id']);
    return $user;
}
```

## üõ°Ô∏è Recursos de Seguran√ßa

### **1. Controle de Tentativas de Login**

```php
// Bloqueio ap√≥s 5 tentativas por 30 minutos
if ($attempts >= 5) {
    $locked_until = date('Y-m-d H:i:s', time() + (30 * 60));
    $updateSql = "UPDATE users SET login_attempts = ?, locked_until = ? WHERE id = ?";
    $updateStmt->execute([$attempts, $locked_until, $user['id']]);
}
```

### **2. Sistema Multi-Tenant**

```php
// Isolamento por tenant_id
$sql = "SELECT * FROM sessions WHERE tenant_id = ? ORDER BY date DESC";
$stmt = $pdo->prepare($sql);
$stmt->execute([$tenant_id]);
```

### **3. Controle de Roles**

```php
// Hierarquia: user < admin < super_admin
$role_hierarchy = ['user' => 1, 'admin' => 2, 'super_admin' => 3];
$user_level = $role_hierarchy[$user_role] ?? 0;
$required_level = $role_hierarchy[$required_role] ?? 999;

if ($user_level < $required_level) {
    http_response_code(403);
    echo json_encode(['error' => 'Permiss√µes insuficientes']);
    exit;
}
```

### **4. Logs de Auditoria**

```php
// Log autom√°tico de todas as a√ß√µes
public static function logAction($pdo, $action, $table_name, $record_id, $old_data, $new_data) {
    $sql = "INSERT INTO audit_logs (tenant_id, user_id, action, table_name, record_id, old_data, new_data, ip_address, user_agent, created_at) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())";
    
    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        self::$current_user['tenant_id'],
        self::$current_user['id'],
        $action, $table_name, $record_id,
        $old_data ? json_encode($old_data) : null,
        $new_data ? json_encode($new_data) : null,
        $_SERVER['REMOTE_ADDR'] ?? null,
        $_SERVER['HTTP_USER_AGENT'] ?? null
    ]);
}
```

## üö® Problemas Identificados

### **1. Chave JWT Hardcoded**
```php
// ‚ùå PROBLEMA: Chave fixa se n√£o tiver .env
self::$secret_key = $_ENV['JWT_SECRET'] ?? 'poker_saas_secret_key_2025_' . hash('sha256', 'luisfboff_poker');
```

**‚úÖ SOLU√á√ÉO:**
```bash
# .env
JWT_SECRET=chave_super_secreta_aleatoria_de_64_caracteres_2025
```

### **2. Refresh Token N√£o Implementado**
```php
// ‚ùå PROBLEMA: Refresh token n√£o funciona
success([
    'message' => 'Refresh token n√£o implementado ainda',
    'action' => 'Fa√ßa login novamente'
]);
```

**‚úÖ SOLU√á√ÉO:**
```php
public static function validateRefreshToken($pdo, $refresh_token) {
    $sql = "SELECT user_id FROM user_sessions WHERE refresh_token = ? AND expires_at > NOW()";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([hash('sha256', $refresh_token)]);
    $session = $stmt->fetch();
    
    if ($session) {
        // Gerar novo JWT
        return self::generateToken($user_data);
    }
    return false;
}
```

### **3. CORS Muito Permissivo**
```php
// ‚ùå PROBLEMA: Permite qualquer origem
header('Access-Control-Allow-Origin: *');
```

**‚úÖ SOLU√á√ÉO:**
```php
$allowed_origins = [
    'https://seudominio.com',
    'https://www.seudominio.com',
    'http://localhost:3000' // Para desenvolvimento
];

$origin = $_SERVER['HTTP_ORIGIN'] ?? '';
if (in_array($origin, $allowed_origins)) {
    header("Access-Control-Allow-Origin: $origin");
}
```

### **4. Senha Tempor√°ria no Registro**
```php
// ‚ùå PROBLEMA: Senha fixa para novos usu√°rios
$password_hash = password_hash('temp123', PASSWORD_DEFAULT);
```

**‚úÖ SOLU√á√ÉO:**
```php
// Gerar senha aleat√≥ria e enviar por email
$temp_password = bin2hex(random_bytes(8));
$password_hash = password_hash($temp_password, PASSWORD_DEFAULT);

// Enviar email com senha tempor√°ria
sendWelcomeEmail($email, $temp_password);
```

## üîß Configura√ß√£o de Produ√ß√£o

### **1. Arquivo .env**
```bash
# Banco de dados
DB_HOST=localhost
DB_NAME=poker_saas
DB_USER=usuario_seguro
DB_PASSWORD=senha_super_segura

# JWT
JWT_SECRET=chave_jwt_aleatoria_de_64_caracteres_minimo

# Email
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=seu_email@gmail.com
SMTP_PASS=sua_senha_app

# CORS
ALLOWED_ORIGINS=https://seudominio.com,https://www.seudominio.com
```

### **2. Configura√ß√£o do Servidor**

```apache
# .htaccess para Apache
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ api/$1 [L]

# Headers de seguran√ßa
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
```

### **3. Configura√ß√£o Nginx**

```nginx
# nginx.conf
location /api/ {
    try_files $uri $uri/ /api/index.php?$query_string;
    
    # Headers de seguran√ßa
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
    
    # CORS
    add_header Access-Control-Allow-Origin "https://seudominio.com";
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
    add_header Access-Control-Allow-Headers "Content-Type, Authorization";
}
```

## üêõ Debug de Problemas

### **1. Verificar Logs do Servidor**
```bash
# Apache
tail -f /var/log/apache2/error.log

# Nginx
tail -f /var/log/nginx/error.log

# PHP
tail -f /var/log/php/error.log
```

### **2. Teste da API**
```bash
# Teste de login
curl -X POST http://seudominio.com/api/auth.php?action=login \
  -H "Content-Type: application/json" \
  -d '{"email":"teste@email.com","password":"senha123"}'

# Teste com token
curl -X GET http://seudominio.com/api/auth.php?action=verify \
  -H "Authorization: Bearer SEU_TOKEN_AQUI"
```

### **3. Debug no C√≥digo**
```php
// Adicionar logs tempor√°rios
error_log("Login attempt: " . $email);
error_log("JWT Generated: " . substr($token, 0, 50));
error_log("DB Connection: " . ($pdo ? "OK" : "FAILED"));
```

### **4. Verificar Banco de Dados**
```sql
-- Verificar usu√°rios
SELECT id, email, is_active, last_login FROM users;

-- Verificar sess√µes ativas
SELECT * FROM user_sessions WHERE expires_at > NOW();

-- Verificar logs de auditoria
SELECT * FROM audit_logs ORDER BY created_at DESC LIMIT 10;
```

## üìä Monitoramento

### **1. M√©tricas de Autentica√ß√£o**
```sql
-- Tentativas de login por dia
SELECT DATE(created_at) as date, COUNT(*) as attempts
FROM audit_logs 
WHERE action = 'failed_login' 
GROUP BY DATE(created_at);

-- Usu√°rios ativos
SELECT COUNT(*) as active_users 
FROM user_sessions 
WHERE expires_at > NOW();

-- Sess√µes por tenant
SELECT t.name, COUNT(s.id) as sessions
FROM tenants t
LEFT JOIN user_sessions s ON t.id = s.tenant_id
GROUP BY t.id, t.name;
```

### **2. Alertas de Seguran√ßa**
```php
// Detectar tentativas suspeitas
$suspicious_attempts = $pdo->query("
    SELECT ip_address, COUNT(*) as attempts 
    FROM audit_logs 
    WHERE action = 'failed_login' 
    AND created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
    GROUP BY ip_address 
    HAVING attempts > 10
")->fetchAll();

if (!empty($suspicious_attempts)) {
    // Enviar alerta para admin
    sendSecurityAlert($suspicious_attempts);
}
```

## üöÄ Melhorias Futuras

### **1. Autentica√ß√£o 2FA**
```php
// Implementar TOTP (Google Authenticator)
class TwoFactorAuth {
    public static function generateSecret() {
        return base32_encode(random_bytes(20));
    }
    
    public static function verifyCode($secret, $code) {
        $timeSlice = floor(time() / 30);
        return self::calculateCode($secret, $timeSlice) === $code;
    }
}
```

### **2. OAuth Social**
```php
// Login com Google/Facebook
class SocialAuth {
    public static function googleLogin($code) {
        // Validar code com Google
        // Criar/atualizar usu√°rio
        // Gerar JWT
    }
}
```

### **3. Rate Limiting**
```php
// Limitar requisi√ß√µes por IP
class RateLimiter {
    public static function checkLimit($ip, $endpoint) {
        $key = "rate_limit:{$ip}:{$endpoint}";
        $attempts = redis()->get($key) ?: 0;
        
        if ($attempts > 100) { // 100 req/hora
            throw new Exception('Rate limit exceeded');
        }
        
        redis()->incr($key);
        redis()->expire($key, 3600); // 1 hora
    }
}
```

## üìù Checklist de Seguran√ßa

- [ ] **Chave JWT segura** (64+ caracteres aleat√≥rios)
- [ ] **HTTPS obrigat√≥rio** em produ√ß√£o
- [ ] **CORS restritivo** (apenas dom√≠nios permitidos)
- [ ] **Rate limiting** implementado
- [ ] **Logs de auditoria** funcionando
- [ ] **Controle de tentativas** ativo
- [ ] **Refresh token** implementado
- [ ] **Senhas tempor√°rias** seguras
- [ ] **Headers de seguran√ßa** configurados
- [ ] **Backup do banco** automatizado

## üÜò Troubleshooting Comum

### **Problema: "Token inv√°lido"**
- Verificar se JWT_SECRET est√° configurado
- Verificar se token n√£o expirou
- Verificar se token n√£o foi invalidado no banco

### **Problema: "CORS error"**
- Verificar configura√ß√£o de CORS no servidor
- Verificar se dom√≠nio est√° na lista de permitidos
- Verificar se requisi√ß√£o est√° sendo feita via HTTPS

### **Problema: "Database error"**
- Verificar conex√£o com banco
- Verificar se tabelas existem
- Verificar permiss√µes do usu√°rio do banco

### **Problema: "Login n√£o funciona"**
- Verificar se usu√°rio est√° ativo
- Verificar se tenant est√° ativo
- Verificar se conta n√£o est√° bloqueada
- Verificar logs de auditoria

---

**üìÖ √öltima atualiza√ß√£o:** Janeiro 2025  
**üë®‚Äçüíª Desenvolvido por:** Luis Fernando  
**üîó Reposit√≥rio:** Poker SaaS Multi-tenant

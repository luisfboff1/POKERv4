# ğŸš€ Deploy Unificado - Poker System  
# Build idÃªntico local â†” produÃ§Ã£o usando script unificado
# Next.js (SSG) + APIs PHP â†’ Hostinger via FTP

name: ğŸš€ Deploy para Hostinger (Build Unificado)

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Instalar dependÃªncias Node.js
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias npm..."
          npm ci --prefer-offline

      - name: ğŸ§¹ Limpar cache
        run: |
          echo "ğŸ§¹ Limpando cache..."
          rm -rf .next node_modules/.cache
          npm cache clean --force

      - name: ğŸ—ï¸ Build Unificado (Script)
        env:
          # VariÃ¡veis carregadas automaticamente do GitHub Secrets
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_ENCRYPTION: ${{ secrets.SMTP_ENCRYPTION }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          NEXT_PUBLIC_API_URL: /api
          NEXT_PUBLIC_GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "ğŸ—ï¸ Executando build unificado..."
          npm run build
          echo "âœ… Build concluÃ­do!"

      - name: ï¿½ Instalar dependÃªncias PHP (Composer)
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias PHP..."
          cd dist/api
          
          if [ -f "composer.json" ]; then
            curl -sS https://getcomposer.org/installer | php
            php composer.phar install --no-dev --optimize-autoloader
            echo "âœ… Composer executado com sucesso"
          else
            echo "âš ï¸ composer.json nÃ£o encontrado, pulando instalaÃ§Ã£o PHP"
          fi
          
          cd ../..

      - name: ğŸ” Verificar build final
        run: |
          echo "ğŸ” Verificando estrutura final do dist/..."
          echo "Arquivos na raiz do dist/:"
          ls -la dist/ | head -10
          echo ""
          echo "Arquivos na API:"
          ls -la dist/api/ | head -10
          echo ""
          echo "Tamanho total do dist/:"
          du -sh dist/

      - name: ï¿½ğŸš€ Deploy para Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USER }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          port: 21
          protocol: ftp
          local-dir: ./dist/
          server-dir: /public_html/poker/
          state-name: .ftp-deploy-sync-state-unified.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.next/**
            **/.ftp-deploy-sync-state*
            **/scripts/**

      - name: âœ… Deploy concluÃ­do
        run: |
          echo "ğŸ‰ Deploy unificado realizado com sucesso!"
          echo "ğŸŒ Site: https://luisfboff.com/poker"
          echo "ï¿½ Build: Processo unificado (local â†” produÃ§Ã£o)"
          echo "ğŸš€ Stack: Next.js + PHP + Build Script Unificado"

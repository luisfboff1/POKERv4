# 🚀 Deploy Unificado - Poker System  
# Build idêntico local ↔ produção usando script unificado
# Next.js (SSG) + APIs PHP → Hostinger via FTP

name: 🚀 Deploy para Hostinger (Build Unificado)

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout código
        uses: actions/checkout@v4

      - name: 🔧 Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: 📦 Instalar dependências Node.js
        run: |
          echo "📦 Instalando dependências npm..."
          npm ci --prefer-offline

      - name: 🧹 Limpar cache
        run: |
          echo "🧹 Limpando cache..."
          rm -rf .next node_modules/.cache
          npm cache clean --force

      - name: 🏗️ Build Unificado (Script)
        env:
          # Variáveis carregadas automaticamente do GitHub Secrets
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_ENCRYPTION: ${{ secrets.SMTP_ENCRYPTION }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          NEXT_PUBLIC_API_URL: /api
          NEXT_PUBLIC_GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "🏗️ Executando build unificado..."
          npm run build
          echo "✅ Build concluído!"

      - name: � Instalar dependências PHP (Composer)
        run: |
          echo "📦 Instalando dependências PHP..."
          cd dist/api
          
          if [ -f "composer.json" ]; then
            curl -sS https://getcomposer.org/installer | php
            php composer.phar install --no-dev --optimize-autoloader
            echo "✅ Composer executado com sucesso"
          else
            echo "⚠️ composer.json não encontrado, pulando instalação PHP"
          fi
          
          cd ../..

      - name: 🔍 Verificar build final
        run: |
          echo "🔍 Verificando estrutura final do dist/..."
          echo "Arquivos na raiz do dist/:"
          ls -la dist/ | head -10
          echo ""
          echo "Arquivos na API:"
          ls -la dist/api/ | head -10
          echo ""
          echo "Tamanho total do dist/:"
          du -sh dist/

      - name: �🚀 Deploy para Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USER }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          port: 21
          protocol: ftp
          local-dir: ./dist/
          server-dir: /public_html/poker/
          state-name: .ftp-deploy-sync-state-unified.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.next/**
            **/.ftp-deploy-sync-state*
            **/scripts/**

      - name: ✅ Deploy concluído
        run: |
          echo "🎉 Deploy unificado realizado com sucesso!"
          echo "🌐 Site: https://luisfboff.com/poker"
          echo "� Build: Processo unificado (local ↔ produção)"
          echo "🚀 Stack: Next.js + PHP + Build Script Unificado"

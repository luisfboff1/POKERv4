# âš ï¸ ATENÃ‡ÃƒO: Deploy atualizado para Next.js + TypeScript
# Sistema modernizado: Next.js (SSG) + Tailwind 4.1 + shadcn/ui + TypeScript
# Deploy: Next.js build estÃ¡tico + FTP para Hostinger - ATUALIZADO âœ…

name: ğŸš€ Deploy para Hostinger (Next.js)

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias do Next.js..."
          npm install

      - name: ğŸ—ï¸ Build Next.js (SSG)
        run: |
          echo "ğŸ—ï¸ Construindo aplicaÃ§Ã£o Next.js para produÃ§Ã£o..."

          # Configurar variÃ¡veis de ambiente FRONTEND (apenas NEXT_PUBLIC_*)
          echo "NEXT_PUBLIC_API_URL=/api" > .env.local
          echo "NEXT_PUBLIC_GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> .env.local

          # Build Next.js (gera arquivos estÃ¡ticos em /dist)
          npm run build

          echo "âœ… Build Next.js concluÃ­do!"

      - name: ğŸ”§ Configurar APIs PHP
        run: |
          echo "ğŸ”§ Copiando APIs PHP existentes..."

          # Copiar pasta api/ para dentro de dist/
          mkdir -p dist/api
          cp -r api/* dist/api/
          echo "âœ… APIs PHP copiadas!"

          echo "ğŸ”§ Configurando variÃ¡veis de ambiente PHP..."

          # Criar .env para o backend PHP
          echo "# Banco de Dados" > dist/api/.env
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> dist/api/.env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> dist/api/.env
          echo "DB_USER=${{ secrets.DB_USER }}" >> dist/api/.env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> dist/api/.env
          echo "" >> dist/api/.env
          echo "# JWT Secret" >> dist/api/.env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> dist/api/.env
          echo "" >> dist/api/.env
          echo "# Email (SMTP)" >> dist/api/.env
          echo "SMTP_HOST=${{ secrets.SMTP_HOST }}" >> dist/api/.env
          echo "SMTP_PORT=${{ secrets.SMTP_PORT }}" >> dist/api/.env
          echo "SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}" >> dist/api/.env
          echo "SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}" >> dist/api/.env
          echo "SMTP_ENCRYPTION=${{ secrets.SMTP_ENCRYPTION }}" >> dist/api/.env
          echo "" >> dist/api/.env
          echo "# PokerBot (Groq AI)" >> dist/api/.env
          echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> dist/api/.env

          echo "ğŸ“¦ Instalando PHPMailer via Composer..."
          cd dist/api
          curl -sS https://getcomposer.org/installer | php
          php composer.phar install --no-dev --optimize-autoloader
          cd ../..

          echo "ğŸ“„ Copiando .htaccess..."
          cp .htaccess dist/ || echo "âš ï¸ .htaccess nÃ£o encontrado"

          echo "âœ… Build e configuraÃ§Ã£o concluÃ­dos!"
          ls -la dist/
          ls -la dist/api/

      - name: ğŸš€ Deploy para Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USER }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          port: 21
          protocol: ftp
          local-dir: ./dist/
          server-dir: /poker/
          state-name: .ftp-deploy-sync-state-nextjs.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.next/**
            **/api/.env
            **/.ftp-deploy-sync-state*

      - name: âœ… Deploy concluÃ­do
        run: |
          echo "ğŸ‰ Deploy realizado com sucesso!"
          echo "ğŸŒ Site disponÃ­vel em: https://luisfboff.com"
          echo "ğŸ“§ Contato: luis@luisfboff.com"
          echo "ğŸ‘¨â€ğŸ’» Desenvolvedor: Luis Fernando Boff"
          echo "ğŸš€ Stack: Next.js + TypeScript + Tailwind 4.1 + shadcn/ui"

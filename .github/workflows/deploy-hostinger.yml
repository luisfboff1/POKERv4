# âš ï¸ ATENÃ‡ÃƒO: Deploy atualizado para Next.js + TypeScript
# Sistema modernizado: Next.js (SSG) + Tailwind 4.1 + shadcn/ui + TypeScript
# Deploy: Next.js build estÃ¡tico + FTP para Hostinger - ATUALIZADO âœ…

name: ðŸš€ Deploy para Hostinger (Next.js)

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          echo "ðŸ“¦ Instalando dependÃªncias (com cache)..."
          npm install --prefer-offline --no-audit --no-fund

      - name: ðŸ—ï¸ Build Next.js (SSG)
        run: |
          echo "ðŸ—ï¸ Construindo aplicaÃ§Ã£o Next.js para produÃ§Ã£o..."

          # Configurar variÃ¡veis de ambiente FRONTEND (apenas NEXT_PUBLIC_*)
          echo "NEXT_PUBLIC_API_URL=/api" > .env.local
          echo "NEXT_PUBLIC_GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> .env.local

          # Build Next.js (gera arquivos estÃ¡ticos em /dist)
          npm run build

          echo "âœ… Build Next.js concluÃ­do!"

      - name: ðŸ”§ Configurar APIs PHP
        run: |
          echo "ðŸ”§ Preparando pasta dist/api..."
          mkdir -p dist/api

          echo "ðŸ“‹ Copiando APIs PHP..."
          cp -r api/* dist/api/
          echo "âœ… APIs copiadas!"

          echo "ðŸ”§ Criando arquivo .env..."
          {
            echo "DB_HOST=${{ secrets.DB_HOST }}"
            echo "DB_NAME=${{ secrets.DB_NAME }}"
            echo "DB_USER=${{ secrets.DB_USER }}"
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}"
            echo "SMTP_HOST=${{ secrets.SMTP_HOST }}"
            echo "SMTP_PORT=${{ secrets.SMTP_PORT }}"
            echo "SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}"
            echo "SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}"
            echo "SMTP_ENCRYPTION=${{ secrets.SMTP_ENCRYPTION }}"
            echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}"
          } > dist/api/.env

          echo "ðŸ“„ Verificando .env criado:"
          ls -la dist/api/.env
          echo "Tamanho do arquivo:" $(wc -c < dist/api/.env) "bytes"

          echo "ðŸ“¦ Instalando PHPMailer via Composer..."
          cd dist/api
          curl -sS https://getcomposer.org/installer | php
          php composer.phar install --no-dev --optimize-autoloader
          cd ../..

          echo "ðŸ“„ Copiando .htaccess..."
          cp .htaccess dist/ || echo "âš ï¸ .htaccess nÃ£o encontrado"

          echo "âœ… Build e configuraÃ§Ã£o concluÃ­dos!"
          echo "Arquivos em dist:"
          ls -la dist/
          echo "Arquivos em dist/api:"
          ls -la dist/api/ | head -20

      - name: ðŸš€ Deploy para Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USER }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          port: 21
          protocol: ftp
          local-dir: ./dist/
          server-dir: /poker/
          state-name: .ftp-deploy-sync-state-nextjs.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.next/**
            **/.ftp-deploy-sync-state*

      - name: âœ… Deploy concluÃ­do
        run: |
          echo "ðŸŽ‰ Deploy realizado com sucesso!"
          echo "ðŸŒ Site disponÃ­vel em: https://luisfboff.com"
          echo "ðŸ“§ Contato: luis@luisfboff.com"
          echo "ðŸ‘¨â€ðŸ’» Desenvolvedor: Luis Fernando Boff"
          echo "ðŸš€ Stack: Next.js + TypeScript + Tailwind 4.1 + shadcn/ui"

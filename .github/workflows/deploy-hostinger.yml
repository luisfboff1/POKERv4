# ⚠️ ATENÇÃO: Deploy atualizado para Next.js + TypeScript
# Sistema modernizado: Next.js (SSG) + Tailwind 4.1 + shadcn/ui + TypeScript
# Deploy: Next.js build estático + FTP para Hostinger - ATUALIZADO ✅

name: 🚀 Deploy para Hostinger (Next.js)

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout código
        uses: actions/checkout@v4

      - name: 🔧 Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 📦 Instalar dependências
        run: |
          echo "📦 Instalando dependências do Next.js..."
          npm install

      - name: 🏗️ Build Next.js (SSG)
        run: |
          echo "🏗️ Construindo aplicação Next.js para produção..."

          # Configurar variáveis de ambiente FRONTEND (apenas NEXT_PUBLIC_*)
          echo "NEXT_PUBLIC_API_URL=/api" > .env.local
          echo "NEXT_PUBLIC_GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> .env.local

          # Build Next.js (gera arquivos estáticos em /dist)
          npm run build

          echo "✅ Build Next.js concluído!"

      - name: 🔧 Configurar APIs PHP
        run: |
          echo "🔧 Copiando APIs PHP existentes..."

          # Copiar pasta api/ para dentro de dist/
          mkdir -p dist/api
          cp -r api/* dist/api/
          echo "✅ APIs PHP copiadas!"

          echo "🔧 Configurando variáveis de ambiente PHP..."

          # Criar .env para o backend PHP
          echo "# Banco de Dados" > dist/api/.env
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> dist/api/.env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> dist/api/.env
          echo "DB_USER=${{ secrets.DB_USER }}" >> dist/api/.env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> dist/api/.env
          echo "" >> dist/api/.env
          echo "# JWT Secret" >> dist/api/.env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> dist/api/.env
          echo "" >> dist/api/.env
          echo "# Email (SMTP)" >> dist/api/.env
          echo "SMTP_HOST=${{ secrets.SMTP_HOST }}" >> dist/api/.env
          echo "SMTP_PORT=${{ secrets.SMTP_PORT }}" >> dist/api/.env
          echo "SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}" >> dist/api/.env
          echo "SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}" >> dist/api/.env
          echo "SMTP_ENCRYPTION=${{ secrets.SMTP_ENCRYPTION }}" >> dist/api/.env
          echo "" >> dist/api/.env
          echo "# PokerBot (Groq AI)" >> dist/api/.env
          echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> dist/api/.env

          echo "📦 Instalando PHPMailer via Composer..."
          cd dist/api
          curl -sS https://getcomposer.org/installer | php
          php composer.phar install --no-dev --optimize-autoloader
          cd ../..

          echo "📄 Copiando .htaccess..."
          cp .htaccess dist/ || echo "⚠️ .htaccess não encontrado"

          echo "✅ Build e configuração concluídos!"
          ls -la dist/
          ls -la dist/api/

      - name: 🚀 Deploy para Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.HOSTINGER_FTP_HOST }}
          username: ${{ secrets.HOSTINGER_FTP_USER }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          port: 21
          protocol: ftp
          local-dir: ./dist/
          server-dir: /poker/
          state-name: .ftp-deploy-sync-state-nextjs.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.next/**
            **/api/.env
            **/.ftp-deploy-sync-state*

      - name: ✅ Deploy concluído
        run: |
          echo "🎉 Deploy realizado com sucesso!"
          echo "🌐 Site disponível em: https://luisfboff.com"
          echo "📧 Contato: luis@luisfboff.com"
          echo "👨‍💻 Desenvolvedor: Luis Fernando Boff"
          echo "🚀 Stack: Next.js + TypeScript + Tailwind 4.1 + shadcn/ui"
